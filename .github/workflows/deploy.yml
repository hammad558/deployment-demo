name: CI/CD Pipeline

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm install
        
      - name: Run tests
        run: npm test -- --coverage --watchAll=false
        
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Get version
        id: package-version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
        
      - name: Install dependencies
        run: npm install
        
      - name: Build application
        env:
          REACT_APP_VERSION: ${{ steps.package-version.outputs.version }}
          REACT_APP_BUILD_DATE: ${{ github.event.head_commit.timestamp }}
        run: npm run build
        
      - name: Create build archive
        run: |
          cd build
          tar -czf ../build-${{ steps.package-version.outputs.version }}.tar.gz .
          cd ..
          
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ steps.package-version.outputs.version }}
          path: build-${{ steps.package-version.outputs.version }}.tar.gz
          retention-days: 30
          
      - name: Build summary
        run: |
          echo "### Build Successful! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.package-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build artifact:** build-${{ steps.package-version.outputs.version }}.tar.gz" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    environment:
      name: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Get version
        id: package-version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
        
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-${{ steps.package-version.outputs.version }}
          
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          
      - name: Deploy to EC2
        env:
          VERSION: ${{ steps.package-version.outputs.version }}
        run: |
          # Copy build archive to server
          scp -i ~/.ssh/deploy_key build-${VERSION}.tar.gz ubuntu@${{ secrets.SERVER_HOST }}:/tmp/
          
          # Execute deployment on server
          ssh -i ~/.ssh/deploy_key ubuntu@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            set -e
            
            VERSION="${{ steps.package-version.outputs.version }}"
            DEPLOY_DIR="/var/www/deployment-demo"
            RELEASES_DIR="${DEPLOY_DIR}/releases"
            CURRENT_LINK="${DEPLOY_DIR}/current"
            
            echo "Deploying version ${VERSION}..."
            
            # Create release directory
            mkdir -p ${RELEASES_DIR}/${VERSION}
            
            # Extract build
            tar -xzf /tmp/build-${VERSION}.tar.gz -C ${RELEASES_DIR}/${VERSION}
            
            # Update current symlink
            ln -sfn ${RELEASES_DIR}/${VERSION} ${CURRENT_LINK}
            
            # Reload nginx
            sudo systemctl reload nginx
            
            # Keep only last 5 releases
            cd ${RELEASES_DIR}
            ls -t | tail -n +6 | xargs -r rm -rf
            
            # Remove temp file
            rm /tmp/build-${VERSION}.tar.gz
            
            echo "Deployment completed successfully!"
            echo "Version ${VERSION} is now live"
          ENDSSH
          
      - name: Verify deployment
        run: |
          sleep 5
          curl -f http://${{ secrets.SERVER_HOST }} || exit 1
          echo "Deployment verified successfully!"
          
      - name: Deployment summary
        run: |
          echo "### Deployment Successful! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.package-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** http://${{ secrets.SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
